<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Document</title>
  <link rel="stylesheet" type="text/css" href="./res/static/css/main.css">
  <link rel="stylesheet" type="text/css" href="./res/layui/css/layui.css">
  <script type="text/javascript" src="./res/layui/layui.js"></script>
  <!-- 引入bootstrap的js -->
  <script src="/js/bootstrap/js/jquery-3.3.1.min.js"></script>
  <script src="/js/bootstrap/js/bootstrap.min.js"></script>
  <link href="/js/bootstrap/css/bootstrap.min.css" rel="stylesheet"></link>
  <!-- 引入bootbox的js -->
  <script src="/js/bootstrap-bootbox/bootbox.locales.min.js"></script>
  <script src="/js/bootstrap-bootbox/bootbox.min.js"></script>
  <!-- 引入DataTables的js -->
  <link href="/js/bootstrap-DataTables/css/jquery.dataTables.css" rel="stylesheet">
  <script src="/js/bootstrap-DataTables/js/jquery.dataTables.js" charset="utf8"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
</head>
<body>

  <div class="site-nav-bg">
    <div class="site-nav w1200">
      <p class="sn-back-home">
        <i class="layui-icon layui-icon-home"></i>
        <a href="#">首页</a>
      </p>
      <div class="sn-quick-menu">
        <div class="login"><a href="login.html">登录</a></div>
        <div class="sp-cart"><a href="shopcart.html">购物车</a><span id="cartCount"></span></div>
        <div class="sp-cart"><a href="myOrder.html">我的订单</a></div>
      </div>
    </div>
  </div>



  <div class="header">
    <div class="headerLayout w1200">
      <div class="headerCon">
        <h1 class="mallLogo">
          <a href="#" title="母婴商城">
            <img src="./res/static/img/logo.png">
          </a>
        </h1>
        <div class="mallSearch">
          <form action="" class="layui-form" novalidate>
            <input type="text" name="title" required  lay-verify="required" autocomplete="off" class="layui-input" placeholder="请输入需要的商品">
            <button class="layui-btn" lay-submit lay-filter="formDemo">
                <i class="layui-icon layui-icon-search"></i>
            </button>
            <input type="hidden" name="" value="">
          </form>
        </div>
      </div>
    </div>
  </div>


  <div class="content content-nav-base shopcart-content">
    <div class="main-nav">
      <div class="inner-cont0">
        <div class="inner-cont1 w1200">
          <div class="inner-cont2">
            <a href="commodity.html" class="active">所有商品</a>
            <a href="buytoday.html">今日团购</a>
            <a href="information.html">母婴资讯</a>
            <a href="about.html">关于我们</a>
          </div>
        </div>
      </div>
    </div>
    <div class="banner-bg w1200">
      <h3>夏季清仓</h3>
      <p>宝宝被子、宝宝衣服3折起</p>
    </div>
    <div class="cart w1200">
      <div class="cart-table-th">
        <div class="th th-chk">
          <div class="select-all">
            <div class="cart-checkbox">
              <input class="check-all check" id="allCheckked" name="true" type="checkbox" value="" onclick="qx()">
            </div>
          <label>&nbsp;&nbsp;全选</label>
          </div>
        </div>
        <div class="th th-item">
          <div class="th-inner">
            商品
          </div>
        </div>
        <div class="th th-price">
          <div class="th-inner">
            单价
          </div>
        </div>
        <div class="th th-amount">
          <div class="th-inner">
            数量
          </div>
        </div>
        <div class="th th-sum">
          <div class="th-inner">
            小计
          </div>
        </div>
        <div class="th th-op">
          <div class="th-inner">
            操作
          </div>
        </div>  
      </div>



      <div class="OrderList">
        <div class="order-content" id="list-cont" >

            <div id="cartDiv"></div>

        </div>
      </div>


      <!-- 模版导入数据 -->
      <!-- <script type="text/html" id="demo">
        {{# layui.each(d.infoList,function(index,item){}}
          <ul class="item-content layui-clear">
            <li class="th th-chk">
              <div class="select-all">
                <div class="cart-checkbox">
                  <input class="CheckBoxShop check" id="" type="checkbox" num="all" name="select-all" value="true">
                </div>
              </div>
            </li>
            <li class="th th-item">
              <div class="item-cont">
                <a href="javascript:;"><img src="./res/static/img/paging_img1.jpg" alt=""></a>
                <div class="text">
                  <div class="title">宝宝T恤棉质小衫</div>
                  <p><span>粉色</span>  <span>130</span>cm</p>
                </div>
              </div>
            </li>
            <li class="th th-price">
              <span class="th-su">189.00</span>
            </li>
            <li class="th th-amount">
              <div class="box-btn layui-clear">
                <div class="less layui-btn">-</div>
                <input class="Quantity-input" type="" name="" value="1" disabled="disabled">
                <div class="add layui-btn">+</div>
              </div>
            </li>
            <li class="th th-sum">
              <span class="sum">189.00</span>
            </li>
            <li class="th th-op">
              <span class="dele-btn">删除</span>
            </li>
          </ul>
        {{# });}}
      </script> -->


      <div class="FloatBarHolder layui-clear">
        <div class="th th-chk">
          <div class="select-all">
            <div class="cart-checkbox">
            </div>
            <label>&nbsp;&nbsp;已选<span class="Selected-pieces" id="checkId">0</span>件</label>
          </div>
        </div>
        <div class="th batch-deletion">
          <span class="batch-dele-btn">批量删除</span>
        </div>
        <div class="th Settlement">
          <button class="layui-btn" onclick="location.href='order.html'">结算</button>
        </div>
        <div class="th total">
          <p>应付：<span class="pieces-total" id="allMoney">0</span></p>
        </div>
      </div>



    </div>
  </div>

<!--<script type="text/javascript">-->
  <!--layui.config({-->
    <!--base: './res/static/js/util/' //你存放新模块的目录，注意，不是layui的模块目录-->
  <!--}).use(['mm','jquery','element','car'],function(){-->
    <!--var mm = layui.mm,$ = layui.$,element = layui.element,car = layui.car;-->
    <!---->
    <!--// 模版导入数据-->
    <!--// var html = demo.innerHTML,-->
    <!--// listCont = document.getElementById('list-cont');-->
    <!--// mm.request({-->
    <!--//   url: './json/shopcart.json',-->
    <!--//   success : function(res){-->
    <!--//     listCont.innerHTML = mm.renderHtml(html,res)-->
    <!--//     element.render();-->
    <!--//     car.init()-->
    <!--//   },-->
    <!--//   error: function(res){-->
    <!--//     console.log(res);-->
    <!--//   }-->
    <!--// })-->
    <!--// -->
    <!--car.init()-->


<!--});-->
<!--</script>-->

<script>

  $(function () {
      initCartGoods();
  })


  //=================ajax的全局处理
  $.ajaxSetup({
      //data:{"name":sessionStorage.getItem("token")}//第一种
      headers: {
          'token': sessionStorage.getItem("login_token"),
          // 'iphone': sessionStorage.getItem("iphone")
      },
      /* beforeSend: function(xhr) {
           debugger;
           xhr.setRequestHeader("token:'"+sessionStorage.getItem("login_token")+"'");//第三种
       }*/
      //数据加载完成后
      complete:function(a,b,c){
          var rs=a.responseJSON;
          if(rs.code==1000){
              alert(rs.message);
              location.href="login.html"
          }
      }
  });



  //=========================拼接购物车商品
  var cartList;
  var tongji=0;
  function initCartGoods() {
      $.post({
          url:"http://localhost:8080/CartController/queryRedisGoods",
          dataType:"json",
          async:false,
          success:function (rs) {
              debugger
              if(rs.code==200){
                  cartList=eval(rs.data);
                  var cartHtml="";

                  for (var i = 0; i < cartList.length; i++) {
                      var isCheckHtml="<input class=\"CheckBoxShop check\" id=\""+cartList[i].id+"\" type=\"checkbox\" num=\"all\" name=\"select-all\" onclick='checkDlick()' value=\""+cartList[i].money+"\">";
                      if(cartList[i].check==true){
                          isCheckHtml="<input class=\"CheckBoxShop check\" id=\""+cartList[i].id+"\" type=\"checkbox\" num=\"all\" name=\"select-all\" onclick='checkDlick()' checked value=\""+cartList[i].money+"\">";
                          tongji++;
                      }

                      cartHtml+="<ul class=\"item-content layui-clear\">";
                      cartHtml+="<li class=\"th th-chk\">\n" +
                          "              <div class=\"select-all\">\n" +
                          "                <div class=\"cart-checkbox\">\n" +
                          isCheckHtml+
                          "                </div>\n" +
                          "              </div>\n" +
                          "            </li>";
                      cartHtml+="<li class=\"th th-item\">\n" +
                          "              <div class=\"item-cont\">\n" +
                          "                <a href=\"javascript:;\"><img src=\""+cartList[i].imgpath+"\" alt=\"\"></a>\n" +
                          "                <div class=\"text\">\n" +
                          "                  <div class=\"title\">"+cartList[i].name+"</div>\n" +
                          "                </div>\n" +
                          "              </div>\n" +
                          "            </li>";
                      cartHtml+="<li class=\"th th-price\">\n" +
                          "              <span class=\"th-su\">"+cartList[i].price+"</span>\n" +
                          "            </li>";
                      cartHtml+="<li class=\"th th-amount\">\n" +
                          "              <div class=\"box-btn layui-clear\">\n" +
                          "                <div class=\"less layui-btn\" onclick='dilckDown("+cartList[i].id+")'>-</div>\n" +
                          "                <input class=\"Quantity-input\" type=\"\" name=\"\" id='upId"+cartList[i].id+"' value=\""+cartList[i].count+"\" disabled=\"disabled\">\n" +
                          "                <div class=\"add layui-btn\" onclick='dlickUp("+cartList[i].id+")'>+</div>\n" +
                          "              </div>\n" +
                          "            </li>";
                      cartHtml+="<li class=\"th th-sum\">\n" +
                          "              <span class=\"sum\" name='moneyName'>"+cartList[i].money+"</span>\n" +
                          "            </li>";
                      cartHtml+="<li class=\"th th-op\">\n" +
                          "              <span class=\"dele-btn\" onclick='deleteCartGoods("+cartList[i].id+")'>删除</span>\n" +
                          "            </li>";

                      cartHtml+="</ul>";
                  }
                  if(tongji==cartList.length){
                      $("#allCheckked").prop("checked","checked");
                      $("#checkId").prop("checked","checked");
                      //checkDlick()
                  }
                  $("#cartDiv").html(cartHtml);
              }
          },
          error:function () {
              alert("加载购物车异常！");
          }
      })
  }

  //点击事件
  function checkDlick() {
      var checkNum=0;
      var totalMoney=0;
      var checkedGids="";
      $("[name='select-all']:checked").each(function () {
          checkNum++;
          totalMoney=totalMoney+Number(this.value);
          checkedGids+=this.id+",";
      })
debugger
      if(cartList.length > checkNum){
          $("#allCheckked").prop("checked",false);
          $("#checkId").prop("checked",false);
      }else if(cartList.length == checkNum || checkNum != 0){
          $("#allCheckked").prop("checked",true);
          $("#checkId").prop("checked","checked");
      }
      $("#checkId").text(checkNum);
      $("#allMoney").text(totalMoney);

      //修改checked
      $.post({
          url:"http://localhost:8080/CartController/updateCartGoods",
          dataType:"json",
          data:{"gids":checkedGids},
          success:function(rs){
              if(rs.code==200){
                  alert(rs.message);
              }
          },
          error:function(){
              alert("修改异常！");
          }
      })

  }


  //全选
  function qx(){
      var arr=document.getElementsByName("select-all");
      var is=document.getElementById("allCheckked").checked;
      if(is==true){
          for (var i = 0; i < arr.length; i++) {
              arr[i].checked=true;
          }
      }else {
          for (var i = 0; i < arr.length; i++) {
              arr[i].checked=false;
          }
      }
      var checkNum=0;
      var totalMoney=0;
      $("[name='select-all']:checked").each(function () {
          checkNum++;
          debugger
          totalMoney=totalMoney+Number(this.value);
      })
      $("#checkId").text(checkNum);
      $("#allMoney").text(totalMoney);
  }


  //删除
  function deleteCartGoods(id){
      $.ajax({
          data:{"id":id},
          type:"post",
          url:"http://localhost:8080/CartController/deleteCartGoods",
          success:function(rs){
              bootbox.alert("删除成功");
              var count=rs.data;
              $("#cartCount").text(count);

              initCartGoods();
          },
          error:function(){
              bootbox.alert("删除异常");
          }
      })
  }


  //点击+号
  function dlickUp(id) {
      $.post({
          url:"http://localhost:8080/CartController/addCart",
          dataType:"json",
          data:{"id":id,"count":1},
          success:function (rs){
              if(rs.code==200){
                  if (rs.data>=0) {
                     var countInput= $("#upId"+id).val();
                     $("#upId"+id).val(Number(countInput)+1)
                      initCartGoods();
                  }else {
                      alert("库存不足");
                  }
              }
          },
          error:function () {
              alert("加入购物车异常！")
          }
      })
  }


  //点击-号
  function dilckDown(id) {
      $.post({
          url:"http://localhost:8080/CartController/addCart",
          dataType:"json",
          data:{"id":id,"count":-1},
          success:function (rs){
              if(rs.code==200){
                  var countInput= $("#upId"+id).val();
                  if (countInput<=1) {
                      $("#upId"+id).prop('disabled','disabled');
                      initCartGoods();
                  }else{
                      $("#upId"+id).val(Number(countInput)-1);
                      initCartGoods();
                  }
              }
          },
          error:function () {
              alert("加入购物车异常！")
          }
      })
  }
  

</script>
</body>
</html>